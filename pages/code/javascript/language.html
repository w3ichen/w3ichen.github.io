<!DOCTYPE html>
<html>
<head>
	<title>Javascript>Speech</title>
	<script src="jquery-3.5.1.min.js"></script>
</head>
<body>
	<div id="englishText"></div>
	<div id="translatedText"></div>
	<button onclick="test();">test</button>
	<div id="userSpeaks"></div>
	Learn:
	<select id="targetLang">
		<option value="en-US">English</option>
		<option value="fr">French</option>
		<option value="es">Spanish</option>
		<option value="ar">Arabic</option>
		<option value="hy">Armenian</option>
		<option value="bs">Bosnian</option>
		<option value="bg">Bulgarian</option>
		<option value="zh-Hans">Chinese(Simplified)</option>
		<option value="zh-Hant">Chinese(Traditional)</option>
		<option value="cs">Czech</option>
		<option value="da">Danish</option>
		<option value="nl">Dutch</option>
		<option value="fi">Finnish</option>
		<option value="de">German</option>
		<option value="el">Greek</option>
		<option value="he">Hebrew</option>
		<option value="hi">Hindi</option>
		<option value="hu">Hungarian</option>
		<option value="is">Icelandic</option>
		<option value="id">Indonesian</option>
		<option value="ga">Irish</option>
		<option value="it">Italian</option>
		<option value="ja">Japanese</option>
		<option value="ko">Korean</option>
		<option value="no">Norwegian</option>
		<option value="fa">Persian</option>
		<option value="pl">Polish</option>
		<option value="pt">Portuguese</option>
		<option value="pa">Punjabi</option>
		<option value="ro">Romanian</option>
		<option value="ru">Russian</option>
		<option value="sr">Serbian</option>
		<option value="sk">Slovak</option>
		<option value="sl">Slovenian</option>
		<option value="sv">Swedish</option>
		<option value="th">Thai</option>
		<option value="tr">Turkish</option>
		<option value="uk">Ukrainian</option>
		<option value="vi">Vietnamese</option>
		<option value="cy">Welsh</option>
	</select>
	<button onclick="text2speech('HELLO')">SPEAK</button>


</body>
<script type="text/javascript">
//SETTINGS
// SPEECH2TEXT
try{
	var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
	var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;
}catch (err){
	alert("Your browser does not support SpeechRecognition\nPlease try another browser\nERROR: "+err)
}
var grammar = '#JSGF v1.0';
var recognition = new SpeechRecognition();
var SpeechRecognitionGrammarList = new SpeechGrammarList()
recognition.grammars = SpeechRecognitionGrammarList
recognition.continuous = false;
recognition.interimResults = false; // whether to get results when user is still speaking
SpeechRecognitionGrammarList.addFromString(grammar, 1)
// TEXT2SPEECH
var msg = new SpeechSynthesisUtterance();
msg.volume = 1; // 0 to 1
msg.rate = 0.9; // 0.1 to 10

var sentences;
fetch('language.txt')
.then(response => response.text())
.then(text => {
	sentences = text.split("~");
})

function test(){
	let text = "how are you";
	document.getElementById("englishText").innerHTML = text;
	translate("en-US",document.getElementById("targetLang").value, text, true)
	speech2text();
}
function speech2text(){
	// LANGUAGE
	recognition.lang = document.getElementById("targetLang").value;
	recognition.start();
	recognition.onresult = function(event){
		console.log(event.results[0][0].transcript)
		document.getElementById("userSpeaks").innerHTML = event.results[0][0].transcript;
		checkSimilar(); // check if what user said is similar to translation
	}
	recognition.onspeechend = function(){
		recognition.stop();
	}
	recognition.onerror = function(event){
		console.log(event.error)
	}
}


function translate(sourceLang, targetLang, text, speak=false){
	var url = "https://translate.googleapis.com/translate_a/single?client=gtx&sl="
            + sourceLang + "&tl=" + targetLang + "&dt=t&q=" + encodeURI(text);
    fetch(url)
    .then(promise=>promise.json())
    .then(translated=>{
    	translation = translated[0][0][0];
    	console.log(translation)
    	if (speak){
    		try{
    			msg.text = translation;
    		}catch(err){
    			alert("Your browser does not support SpeechSynthesisUtterance\nPlease try another browser\nERROR: "+err)
    		}
    		msg.lang = document.getElementById("targetLang").value;
			window.speechSynthesis.speak(msg);
			// write out the translation
			document.getElementById("translatedText").innerHTML = translation;
    	}
    })
}
// languages that are represented by characters
var notSpaceSeparated = ['ja','ko','th','zh-Hans','zh-Hant','he','hi','ar','el']
function checkSimilar(){
	if (notSpaceSeparated.includes(document.getElementById("targetLang").value)){
		// language is not space separated, use unicode
		userWords = toUnicode(document.getElementById("userSpeaks").innerHTML).split(/\\u/g);
		translation = toUnicode(document.getElementById("translatedText").innerHTML).split(/\\u/g);
		var markedString = "";
		for (var i=1;i<userWords.length;i++){
			if (translation.includes(userWords[i])){
				// mark green since user word is in translation
				markedString += "<mark>"+String.fromCharCode(parseInt(userWords[i], 16))+"</mark>";
			}else{
				markedString += String.fromCharCode(parseInt(userWords[i], 16));
			}
		}
	}else{
		// language is space separated, split by space
		userWords = document.getElementById("userSpeaks").innerHTML.split(/ /g);
		translation = document.getElementById("translatedText").innerHTML.split(/ /g);
		var markedString = "";
		for (var i=0;i<userWords.length;i++){
			if (translation.includes(userWords[i])){
				// mark green since user word is in translation
				markedString += "<mark>"+userWords[i]+"</mark>&nbsp;";
			}else{
				markedString += userWords[i]+"&nbsp;";
			}
		}
	}
	console.log("TEXT FILE: ",sentences[0])
	console.log("MARKED: ",markedString)
	document.getElementById("userSpeaks").innerHTML = markedString;

}
function toUnicode(theString) {
  var unicodeString = '';
  for (var i=0; i < theString.length; i++) {
    var theUnicode = theString.charCodeAt(i).toString(16).toUpperCase();
    while (theUnicode.length < 4) {
      theUnicode = '0' + theUnicode;
    }
    theUnicode = '\\u' + theUnicode;
    unicodeString += theUnicode;
  }
  return unicodeString;
}



</script>

<style type="text/css">
mark{
	color: green;
	background-color: white;
}

</style>
</html>